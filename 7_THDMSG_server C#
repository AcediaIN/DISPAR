using System;
using System.IO.Pipes;
using System.Threading;

class Program
{
    public static void Main_Encoding()
    {
        Console.OutputEncoding = Encoding.UTF8;
    }

    static void Main(string[] args)
    {
        Main_Encoding();

        using (NamedPipeServerStream pipeServer = new NamedPipeServerStream("testpipe", PipeDirection.InOut))
        {
            Console.WriteLine("NamedPipeServerStream object created.");

            // Очікуємо на клієнта
            Console.Write("Waiting for client connection...");
            pipeServer.WaitForConnection();

            Console.WriteLine("Client connected.");

            try
            {
                // Очікуємо повідомлення від клієнта
                byte[] buffer = new byte[255];
                int bytesRead = pipeServer.Read(buffer, 0, 255);
                Console.WriteLine("Received message from client: {0}",
                    System.Text.Encoding.UTF8.GetString(buffer, 0, bytesRead));

                // Відправляємо відповідь клієнту
                string response = "Hello from server.";
                byte[] responseBytes = System.Text.Encoding.UTF8.GetBytes(response);
                pipeServer.Write(responseBytes, 0, responseBytes.Length);
                Console.WriteLine("Sent message to client: {0}", response);
            }
            catch (Exception ex)
            {
                Console.WriteLine("Exception: {0}", ex.Message);
            }
        }

        Console.WriteLine("Server closed.");
    }
}
